<html xmlns:py="http://genshi.edgewall.org/"
      xmlns:xi="http://www.w3.org/2001/XInclude"
      py:strip="">

<py:def function="plugin_template(name, instance)"
    py:with="nb_links = len(tg.config['vigiboard_links.eventdetails'])">
<div id="DetailsDialog">
    <h2>State info</h2>
    <div id="state_info">
        <div class="label">
            Initial State:
            <span class="value" id="DetailsDialog_initial_state"></span>
        </div>
        
        <div class="label">
            Current State:
            <span class="value" id="DetailsDialog_current_state"></span>
        </div>
        
        <div class="label">
            Peak State:
            <span class="value" id="DetailsDialog_peak_state"></span>
        </div>
    </div>
    
    <hr />
    
    <h2>Details</h2>
    <div id="history_links">
        <ul>
            <li><a id="DetailsDialog_event" href="#">Detailed history for this event</a></li>
            <li><a id="DetailsDialog_masked" href="#">Masked events for this event</a></li>
            <li><a id="DetailsDialog_item" href="#">Events history for this supervised item</a></li>
        </ul>
    </div>   

    <div py:if="nb_links">
        <hr />

        <h2>External links</h2>
        <div id="external_links">
            <ul>
                <li py:for="edname, edit in tg.config['vigiboard_links.eventdetails'].iteritems()">
                    <a href="#" id="DetailsDialog_${edname}">${edit[0]}</a>
                </li>
            </ul>
        </div>
    </div>
</div>

<script type="text/javascript">
window.details_dialog = null;

window.addEvent("domready", function () {
    /// HACK: voir notes sur window.search_dialog dans vigiboard.html.
    window.details_dialog = new Jx.Dialog({
        label: "${l_('Event details')}",
        modal: false,
        resize: false,
        move: true,
        content: 'DetailsDialog',
        onOpen: window.dlg_open_handler,
        onClose: window.dlg_close_handler,
        width: 275,
        // On essaye d'obtenir une hauteur correcte pour le dialogue,
        // en fonction du nombre de liens externes configur√©s.
        height: ${[190, 220][nb_links != 0] + nb_links * 14},
        closed: true,
        horizontal: 'right left',
        vertical: 'top top',
    });
    window.details_dialog.toggleCollapse();
    window.details_dialog.toggleCollapse();

    $$$$('.Details_Link').each(function (el) {
        el.addEvent('click', function (item) {
            var idd = item.get('href').substring(1);
            var req = new Request.JSON({
                link: 'cancel',
                url: '${tg.url("/get_plugin_value")}',
                onSuccess: function (details, raw) {
                    $$('DetailsDialog_initial_state').set('text', details.initial_state);
                    $$('DetailsDialog_current_state').set('text', details.current_state);
                    $$('DetailsDialog_peak_state').set('text', details.peak_state);
                    $$('DetailsDialog_event').set('href', "${tg.url('/event/')}" + details.idcause);
                    $$('DetailsDialog_masked').set('href', "${tg.url('/masked_events/')}" + details.idcorrevent);
                    if (details.service) {
                        $$('DetailsDialog_item').set('href', "${tg.url('/item/1/')}" + details.host + "/" + details.service);
                    } else {
                        $$('DetailsDialog_item').set('href', "${tg.url('/item/1/')}" + details.host + "/");
                    }
                    <py:for each="edname, edit in tg.config['vigiboard_links.eventdetails'].iteritems()">
                    $$('DetailsDialog_${edname}').set('href', details.eventdetails['${edname}']);
                    </py:for>
                    window.details_dialog.setBusy(false);
                },
                onFailure: function (xhr) {
                    window.details_dialog.setBusy(false);
                },
            });
            window.details_dialog.options.parent = item;
            window.details_dialog.open.bind(window.details_dialog)();
            window.details_dialog.setBusy(true);
            req.post({plugin_name: '${name}', idcorrevent: idd});
        }.bind(this, el));
    }, window.details_dialog);
});
</script>
</py:def>

<th id="plugin_${name}" class="plugin_${name}" py:def="header_template(name, instance)"></th>

<td class="plugin_${name}" py:def="data_template(name, instance, data)">
<a href="#${data[0].idcorrevent}" class="Details_Link">
    <img alt="Details" title="Event details"
        src="${tg.url('/images/%s2.png' % StateName.value_to_statename(data[0].cause.current_state))}" />
</a>
</td>

</html>

