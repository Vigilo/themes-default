<html xmlns:py="http://genshi.edgewall.org/"
      xmlns:xi="http://www.w3.org/2001/XInclude"
      py:strip="">

<th id="plugin_${name}" class="plugin_${name}" py:def="details_header(name, instance)"></th>

<td class="plugin_${name}" py:def="details_data(name, instance, data, plugin_data)">
<a href="#${data[0].idcorrevent}" class="Details_Link">
    <img alt="Details" title="Event details"
        src="${tg.url('/images/%s2.png' % StateName.value_to_statename(data[0].cause.current_state))}" />
</a>
</td>

<py:def function="plugin_template(name, instance)"
    py:with="nb_links = len(tg.config['vigiboard_links.eventdetails'])">
    <?python
        plugin_header_functions[name] = details_header
        plugin_data_functions[name] = details_data
    ?>
<div id="DetailsDialog">
    <div class="loading">
        <img alt="loading..." src="${tg.url('images/loading.gif')}" />
    </div>
    <div class="loading-error">
        <p>Error while loading data...</p>
    </div>
    <h2>State info</h2>
    <div id="state_info">
        <div class="label">
            Initial State:
            <span class="value" id="DetailsDialog_initial_state"></span>
        </div>

        <div class="label">
            Current State:
            <span class="value" id="DetailsDialog_current_state"></span>
        </div>

        <div class="label">
            Peak State:
            <span class="value" id="DetailsDialog_peak_state"></span>
        </div>
    </div>

    <hr />

    <h2>Details</h2>
    <div id="history_links">
        <ul>
            <li><a id="DetailsDialog_event" href="#">Detailed history for this event</a></li>
            <li><a id="DetailsDialog_masked" href="#">Masked events for this event</a></li>
            <li><a id="DetailsDialog_item" href="#">Events history for this supervised item</a></li>
        </ul>
    </div>

    <div py:if="nb_links">
        <hr />

        <h2>External links</h2>
        <div id="external_links">
            <ul>
                <li py:for="edname, edit in enumerate(tg.config['vigiboard_links.eventdetails'])">
                    <a target="_blank" href="#" id="DetailsDialog_${edname}">${edit[0]}</a>
                </li>
            </ul>
        </div>
    </div>
</div>

<script type="text/javascript">/*<![CDATA[*/
window.details_dialog = null;

window.addEvent("domready", function () {
    /// HACK: voir notes sur window.search_dialog dans vigiboard.html.
    window.details_dialog = new Jx.Dialog({
        label: "${l_('Event details')}",
        modal: false,
        resize: false,
        move: true,
        content: 'DetailsDialog',
        onOpen: window.dlg_open_handler,
        onClose: window.dlg_close_handler,
        width: 275,
        // On essaye d'obtenir une hauteur correcte pour le dialogue,
        // en fonction du nombre de liens externes configurés.
        height: ${[190, 220][nb_links != 0] + nb_links * 14},
        closed: true,
        horizontal: 'right left',
        vertical: 'top top'
    });
    window.details_dialog.toggleCollapse();
    window.details_dialog.toggleCollapse();

    function remove_selection() {
        $$$$('.selectedRow').removeClass('selectedRow');
    }

    window.details_dialog.addEvent('close', remove_selection);

    $$$$('.Details_Link').each(function (el) {
        el.addEvent('click', function (item) {
            remove_selection();

            // On supprime les anciens états, pour ne pas induire en erreur l'utilisateur
            // dans le cas où les nouvelles infos prennent un peu de temps à charger.
            $$('DetailsDialog_initial_state').set('text', '');
            $$('DetailsDialog_current_state').set('text', '');
            $$('DetailsDialog_peak_state').set('text', '');

            // On supprime également un éventuel message d'erreur survenu
            // lors d'un précédent affichage de la boîte de dialogue.
            $$$$('.loading-error').setStyle('display', 'none');

            // On affiche une animation pendant toute la durée du chargement
            $$$$('.loading').setStyle('display', 'block');

            var idd = item.get('href').substring(1);
            var req = new Request.JSON({
                link: 'cancel',
                url: '${tg.url("/plugin_json")}',
                onSuccess: function (details, raw) {
                    var i;
                    $$('DetailsDialog_initial_state').set('text', details.initial_state);
                    $$('DetailsDialog_current_state').set('text', details.current_state);
                    $$('DetailsDialog_peak_state').set('text', details.peak_state);
                    $$('DetailsDialog_event').set('href', "${tg.url('/event/')}?idevent=" + encodeURIComponent(details.idcause));
                    $$('DetailsDialog_masked').set('href', "${tg.url('/masked_events/')}?idcorrevent=" + encodeURIComponent(details.idcorrevent));
                    if (details.service) {
                        $$('DetailsDialog_item').set('href', "${tg.url('/item/1/')}?host=" +
                            encodeURIComponent(details.host) + "&service=" +
                            encodeURIComponent(details.service));
                    } else {
                        $$('DetailsDialog_item').set('href', "${tg.url('/item/1/')}?host=" +
                            encodeURIComponent(details.host));
                    }
                    for (i = 0; i < ${len(tg.config['vigiboard_links.eventdetails'])}; i++) {
                        $$('DetailsDialog_'+i.toString()).set('href', details.eventdetails[i.toString()]);
                    }
                    window.details_dialog.setBusy(false);

                    // Arrêt de l'animation de chargement
                    $$$$('.loading').setStyle('display', 'none');

                },
                onFailure: function (xhr) {
                    window.details_dialog.setBusy(false);

                    // Arrêt de l'animation de chargement
                    $$$$('.loading').setStyle('display', 'none');

                    // On affiche un message indiquant qu'une
                    // erreur est survenue durant le chargement
                    $$$$('.loading-error').setStyle('display', 'block');

                    remove_selection();
                    if (!xhr.responseText)
                        return;
                    var res = JSON.decode(xhr.responseText, true);
                    if (res == null || !res.errors)
                        return;
                    alert(res.errors.join('\n'));
                }
            });
            window.details_dialog.options.parent = item;
            // Permet d'afficher l'événement sélectionné autrement.
            item.getParent('tr').addClass('selectedRow');
            window.details_dialog.open.bind(window.details_dialog)();
            window.details_dialog.setBusy(true);
            req.post({plugin_name: '${name}', idcorrevent: idd});
        }.bind(this, el));
    }, window.details_dialog);
});
/*]]>*/</script>
</py:def>

</html>
