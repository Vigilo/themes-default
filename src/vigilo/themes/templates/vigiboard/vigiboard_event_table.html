<html xmlns:py="http://genshi.edgewall.org/"
      xmlns:xi="http://www.w3.org/2001/XInclude"
      py:strip="">


  <xi:include href="vigiboard_history_table.html" />

<py:def function="event_table(events,page,nb_pages,rows_info,edit_event_status_options,history,hist_error,search)">
<?python from genshi import HTML ?>
<?python from vigilo.models import StateName ?>

<table class="vigitable" summary="Event table">
	<thead>
		<tr >
			<td style="width:26px;border-right: solid 1px #4682b4">
			    <py:choose>
				<img py:when="page == 1" src="${tg.url('/images/fleche_up.png')}" alt="Previous" title="Previous page" />
				<a py:otherwise="" href="${tg.url('/%d' % (page-1))}"><img src="${tg.url('/images/fleche_up.png')}" alt="Previous" title="Previous page"/></a>
				</py:choose>
			</td>
			<!--!
				events[0] contient les champs affichés en permanence.
				events[1][6] contient une liste des en-têtes générés par les plugins.
				La somme est calculée de sorte que le bandeau de changement de pages
				est aligné sur le reste du tableau (les alertes).
- 1 + len(events[1][6])
			-->
    		<td colspan="${len(events[0])}" style="color: white;background-color: #4682b4" >${l_('Showing rows %(id_first_row)d to %(id_last_row)d of %(total_rows)d') % rows_info} <br />
    		    <py:if test="nb_pages > 1">
				Pages <py:for each="p in range(1, nb_pages + 1)">
				<a py:if="p != page" href="${tg.url('/%d' % p)}" py:content="p" />
				<span py:if="p == page" py:replace="p" />
				</py:for>
				</py:if>
			</td>
			<td style="width:26px;border-left: solid 1px #4682b4">
			    <py:choose>
				<img py:when="page == nb_pages" src="${tg.url('/images/fleche_down.png')}"  alt="Next" title="Next page" />
				<a py:otherwise="" href="${tg.url('/%d' % (page+1))}"><img src="${tg.url('/images/fleche_down.png')}" alt="Next" title="Next page"/></a>
				</py:choose>
			</td>
		</tr>

		<tr>
			<py:for each="(pname,pstyle) in events[0]">
			<th style="padding: 5px;" py:attrs="pstyle">${HTML(pname)}</th>
			</py:for>
			<th style="width:26px;padding: 0px;"><a class="Edit_EventsLien" href="javascript:vigiboard_edit_eventdialog('all')"><img src="${tg.url('/images/icon_page_edit.png')}" alt="Edit selected" title="Edit all selected events"/></a></th>
			<th style="padding:0px;"><input title="Select/Unselect all" id="vigiboard_checkall_checkbox" type="checkbox" onclick="vigiboard_checkall()" /></th>
		</tr>
	</thead>

	<tbody>
		<py:for each="(event,class_tr,class_td_severity,class_td_date,img_fleche,statu,plugin) in events[1:]">
		<tr py:attrs="class_tr" py:with="cause=event.cause.first()">
			<td style="padding: 3px;" py:attrs="class_td_severity">
			    <a href="javascript:vigiboard_historydialog('${event.idcorrevent}')" class="HistoryLien"><img src="${tg.url(img_fleche['src'])}" style="width:20px" alt="Details" title="Event details" /></a>
		    </td>
			<td py:attrs="class_td_date">
			    <span style="font-weight: bold;">${event.get_date('timestamp_active')}</span>
			    <br />[${event.get_since_date('timestamp_active')}]
			 </td>
			<td py:attrs="class_td_date" style="text-align:center">${event.priority}</td>
			<td py:attrs="class_td_date" style="text-align:center">${event.occurrence}</td>
			<td>${cause.supitem.host.name}</td>
			<td>${cause.supitem.servicename}</td>
			<td>${cause.message}</td>
			<td py:for="plug in plugin" py:attrs="plug[1]">${HTML(plug[0])}</td>
			<td style="text-align: center"><a py:if="event.trouble_ticket is not None" href="${
					tg.config['vigiboard_links.tt'] % {
						'idcorrevent': event.idcorrevent,
						'host': cause.supitem.host.name,
						'service': cause.supitem.servicename,
						'tt': event.trouble_ticket }}">[${event.trouble_ticket}]</a></td>
			<py:choose>
                <py:when test="not (event.status == 'AAClosed' and StateName.value_to_statename(cause.current_state) == u'OK')">
			    <td style="text-align: center"><img src="${statu['src']}" py:if="statu != None" alt="${statu['label']}" title="${statu['label']}"/></td>
			    <td py:attrs="class_td_date" style="padding: 0px;text-align: center"><a class="Edit_EventsLien" href="javascript:vigiboard_edit_eventdialog('${event.idcorrevent}')"><img src="${tg.url('/images/icon_page_edit.png')}" alt="Edit" title="Edit this event"/></a></td>
			    <td py:attrs="class_td_date" style="padding:0px;text-align: center"><input type="checkbox" class="Edit_EventsCheckBox" value="${event.idcorrevent}"/></td>
			    </py:when>
			    <py:otherwise>
			    <td colspan="3" style="text-align: center"><img py:attrs="statu" py:if="statu != None" alt="Status" title="Event status"/></td>
			    </py:otherwise>
            </py:choose>
		</tr>

    		<py:if test="hist_error == True">
			<tr><td colspan="${len(events[0]) + 1 + len(plugin)}">
				${history_table(history[event.idcause], hist_error)}	
			</td></tr>
		    </py:if>
		</py:for>
	
	</tbody>

</table>

${tmpl_context.edit_eventdialog()}
${tmpl_context.searchdialog}
${tmpl_context.historydialog}
<py:for each="fct,tpl in plugin_context">
	${fct()}
	<xi:include href="vigiboard_plugin/${tpl}.html" /> 
</py:for>

<script type="text/javascript">
	function vigiboard_historydialog(idd) {
		$.getJSON("${tg.url('/history_dialog')}",{idcorrevent:idd},function(json){
			$('#HistoryDialog_initial_state').html(json.initial_state);
			$('#HistoryDialog_current_state').html(json.current_state);
			$('#HistoryDialog_peak_state').html(json.peak_state);
			$('#HistoryDialog_detailed_event').attr('href', '${tg.url('/event/')}' + json.idcorrevent);
			$('#HistoryDialog_detailed_host').attr('href', '${tg.url('/host_service/')}' + json.host + "/" + json.service);
			<py:for each="edname, edit in tg.config['vigiboard_links.eventdetails'].iteritems()">
			$('#HistoryDialog_${edname}').attr('href', json.eventdetails['${edname}']);
			</py:for>
			$('#HistoryDialog').dialog('open');
		})
	}
	function vigiboard_edit_eventdialog(idd) {
		$('#edit_event_form_comment').attr('value','');
		$('#edit_event_form_trouble_ticket').attr('value','');
		$('#edit_event_form_tt_create').attr('checked',false);
		$('#edit_event_form_status').find('option:first').attr('selected', 'selected').parent('select');;
		if ( idd == 'all' ) {
			var a = '';
			$('.Edit_EventsCheckBox').each(function() {
				if ( $(this).attr('checked'))
					a += $(this).attr('value') + ',';
			});
			idd = a;
		}
		$('#edit_event_form_id').attr('value',idd);	
		$('#Edit_EventsDialog').dialog('open');
	}
	function vigiboard_searchdialog() {
		$('#search_form_host').attr('value','${search['host']}');
		$('#search_form_service').attr('value','${search['service']}');
		$('#search_form_output').attr('value','${search['output']}');
		$('#search_form_trouble_ticket').attr('value', '${search['tt']}');
		$('#SearchDialog').dialog('open');	
	}
	function vigiboard_checkall() {
		var val = $('#vigiboard_checkall_checkbox').attr('checked');	
		$('input[type=checkbox]').each(function(){$(this).attr('checked',val);});
	}
	$('.HistoryLien').each(function() {
                $(this).click(function(e){
                $('#HistoryDialog').dialog('option','position',[e.clientX+10,e.clientY]);
		})});
	$('.Edit_EventsLien').each(function() {
                $(this).click(function(e){
                $('#Edit_EventsDialog').dialog('option','position',[e.clientX-400-20,e.clientY]);
		})});
	$('#SearchLien').click(function(e){
	        $('#SearchDialog').dialog('option','position','center');
	});
</script>

<div style="display:none" id="HistoryDialog">
Initial State: <span id="HistoryDialog_initial_state" /><br />
Current State: <span id="HistoryDialog_current_state" /><br />
Peak State: <span id="HistoryDialog_peak_state" /><br />
<ul>
	<li><a id="HistoryDialog_detailed_event" href="#">Detailed history for this event</a></li>
	<li><a id="HistoryDialog_detailed_host" href="#">Detailed history for this host/service</a></li>
	<li py:for="edname, edit in tg.config['vigiboard_links.eventdetails'].iteritems()">
		<a href="#" id="HistoryDialog_${edname}">${edit[0]}</a>
	</li>
</ul>
</div>

<div  style="display:none" id="Edit_EventsDialog">
	${tmpl_context.edit_event_form()} 
</div>
<div  style="display:none" id="SearchDialog">
	${tmpl_context.search_form()}
</div>

</py:def>

</html>
