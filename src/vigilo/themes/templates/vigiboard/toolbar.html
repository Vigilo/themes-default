<html xmlns="http://www.w3.org/1999/xhtml"
    xmlns:xi="http://www.w3.org/2001/XInclude"
    xmlns:py="http://genshi.edgewall.org/"
    py:strip="">

<py:def function="toolbar">
<div id="header">
    <span id="logo">
        <a href="${tg.url(tg.config.get('logo_link', '/'))}">
            <img alt="" src="${tg.url('/images/vigilo.png')}"/>
        </a>
    </span>

    <div class="header_item">
        <a href="${tg.url('/')}">
            <img src="${tg.url('/images/home.png')}" alt="Home" title="Home" />
        </a>
        <a id="SearchLien" href="javascript:window.search_dialog.open.bind(window.search_dialog)();">
            <img src="${tg.url('/images/search.png')}" alt="Filter display" title="Filter display"/>
        </a>
        <py:if test="tg.config.get('help_link')">
        <a href="${tg.config['help_link']}">
            <img src="${tg.url('/images/help.png')}" alt="Help" title="Help"/>
        </a>
        </py:if>
        <a href="${tg.url('/logout_handler')}">
            <img src="${tg.url('/images/logout.png')}" alt="Log out" title="Log out"/>
        </a>
    </div>

    <div class="header_item" id="font_size_selector">
        <a href="javascript:change_fontsize('5px')">
            <img alt="Default font size" title="Default font size" src="${tg.url('/images/icn_text_sm.png')}" />
        </a>
        <a href="javascript:change_fontsize('10px')">
            <img alt="Medium font size" title="Medium font size" src="${tg.url('/images/icn_text_md.png')}" />
        </a>
        <a href="javascript:change_fontsize('25px')">
            <img alt="Large font size" title="Large font size" src="${tg.url('/images/icn_text_lg.png')}" />
        </a>
    </div>

    <py:with vars="refresh_delay = float(tg.config.get('refresh_delay', 0)); refresh_enabled = int(tg.session.get('refresh', asbool(tg.config.get('refresh_enabled', False))))">
    <div class="header_item" py:if="refresh_delay">
        <input type="checkbox" id="refresh" onchange="set_refresh();" checked="checked" py:if="refresh_enabled" />
        <input type="checkbox" id="refresh" onchange="set_refresh();" py:if="not refresh_enabled" />
        <label for="refresh">${l_('Refresh every %d seconds') % refresh_delay}</label>
    </div>
    </py:with>

    <div class="header_item">
        Theme
        <select id="theme" class="header_select"
            onchange="change_theme($('theme').get('value'), $('theme').getSelected().get('text'));">
            <py:for each="(theme_name, theme_id, theme_files) in themes"
                py:choose="int(theme_id == active_theme)">
            <option py:when="1" value="${theme_id}" selected="selected">${theme_name}</option>
            <option py:otherwise="" value="${theme_id}">${theme_name}</option>
            </py:for>
        </select>
    </div>

    <div class="header_item" id="search_mode_tip">
        <span py:if="filter(None, search.values())">
            <a href="${tg.url('/')}">${l_('You are in Search mode, click here to return to the initial mode.')}</a>
        </span>
    </div>

    <h1><a href="${tg.url('/')}">VigiBoard</a></h1>
</div>

<script type="text/javascript">
/*<![CDATA[*/
    var vigiloLog = new Log;
    // Activation ou désactivation du log en fonction de valeur de la variable debug.
	vigiloLog.${['disableLog', 'enableLog'][tg.config['debug']]}();

    window.search_dialog = null;
    window.dlg_open_handler = function () { this.isOpen = true; }
    window.dlg_close_handler = function () { this.isOpen = false; }

    window.addEvent('domready', function (){
        /**
         * HACK: le closed: True est nécessaire pour éviter que
         * JxLib affiche le panel lors de la création du dialogue
         * (affiche des rectangles blancs). Avec cette modification,
         * le dialogue apparaît replié, mais est considéré comme
         * déplié par Jx.Dialog. Les toggleCollapse permettent de
         * marquer le Dialog comme replié dans Jx.Dialog avant de
         * le déplier pour qu'il soit affiché correctement.
         */
        window.search_dialog = new Jx.Dialog({
            id: "SearchDialog",
            label: "${l_('Search Event').encode('backslash')}",
            modal: false,
            resize: false,
            move: true,
            content: "search_form",
            onOpen: window.dlg_open_handler,
            onClose: window.dlg_close_handler,
            width: 400,
            height: 325,
            closed: true,
        });
        window.search_dialog.toggleCollapse();
        window.search_dialog.toggleCollapse();

        var selector = new TreeGroup({
            url: '${tg.url("/get_groups")}',
            app_path: '${tg.url("/")}',
            title: '${l_("Select a group").encode("backslash")}',
        });
        $('search_form_supitemgroup').addEvent('click', selector.selectGroup.bind(selector));
        selector.addEvent('select', function (item) {
            $('search_form_supitemgroup.ui').set('value', item.options.label);
            $('search_form_supitemgroup.value').set('value', item.options.data);
        });
        $('search_form_supitemgroup.clear').addEvent('click', function () {
            $('search_form_supitemgroup.ui').set('value', '');
            $('search_form_supitemgroup.value').set('value', '');
        });

        add_autocompleter('search_form_host', 'host', '${tg.url("/autocomplete/host").encode("backslash")}');
        add_autocompleter('search_form_service', 'service', '${tg.url("/autocomplete/service").encode("backslash")}');

        change_refresh_rate(${int(tg.session.get('refresh', asbool(tg.config.get('refresh_enabled', False))))});

        $('search_form_from_date_trigger').addEvent('click', function () {
            $$$$(".calendar").setStyles({"zIndex": window.search_dialog.domObj.getStyle('zIndex').toInt()});
        });

        $('search_form_to_date_trigger').addEvent('click', function () {
            $$$$(".calendar").setStyles({"zIndex": window.search_dialog.domObj.getStyle('zIndex').toInt()});
        });
    });

    function change_fontsize(size) {
        document.body.style.fontSize = size;
        var req = new Request.JSON({
            link: 'cancel',
            url: '${tg.url("/set_fontsize")}',
            onFailure: function () {
                alert("${l_('Unable to save preferences').encode('backslash')}");
            }
        });
        req.post({fontsize: size});

        vigiloLog.log("Font size set to " + size + ".");
    }

    var refresh_timeout = null;
    function change_refresh_rate(enabled) {
        var delay = ${float(tg.config.get('refresh_delay', 0))};
        if (refresh_timeout)
            refresh_timeout = $$clear(refresh_timeout);
        if (parseInt(enabled) && delay)
            refresh_timeout = refresh_page.periodical(delay * 1000);
    }

    function set_refresh() {
        var enabled = $$('refresh').get('checked') ? 1 : 0;
        var req = new Request.JSON({
            link: 'cancel',
            url: '${tg.url("/set_refresh")}',
            onFailure: function () {
                alert("${l_('Unable to save preferences').encode('backslash')}");
            }
        });
        req.post({'refresh': enabled});
        change_refresh_rate(enabled);
    }

    function refresh_page() {
        var dialogs = $$$$(".jxDialog");
        for (var i=0; i<dialogs.length; i++) {
            if (dialogs[i].getStyle('display') != 'none') {
            	vigiloLog.log("A dialog is active on the page ('" + dialogs[i].getElement('.jxDialogLabel').get('text') + "'): refresh is not possible.");
                return;
            }
        }

        vigiloLog.log("No active dialog on the page: refreshing...");
        window.location.reload(true);
    }

    function change_theme(theme_id, theme_name) {
        var req = new Request.JSON({
            link: 'cancel',
            url: '${tg.url("/set_theme")}',
            onFailure: function () {
                alert("${l_('Unable to save preferences').encode('backslash')}");
            }
        });
        req.post({'theme': theme_id});
        setActiveStyleSheet(theme_name);

        vigiloLog.log("Theme set to '" + theme_name + "'.");
    }

    function setActiveStyleSheet(theme_name) {
        $$$$('link[rel~=stylesheet][title]').each(function (link_obj) {
            link_obj.set('disabled', true);
            if (link_obj.get('title') == theme_name)
                link_obj.set('disabled', false);
        })
    }

    function add_autocompleter(elem, varname, url) {
        new Autocompleter.Request.VigiloJSON(elem, url, {
            // ATTENTION: domObj n'est pas documenté dans l'API.
            zIndex: window.search_dialog.domObj.getStyle('zIndex').toInt(),
            minLength: 3,
            selectMode: 'type-ahead',
            postVar: varname,
        });
    }
/*]]>*/
</script>
</py:def>
</html>
